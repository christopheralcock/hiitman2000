<!--

features to come:
  actual ui instead of params to try and get this working on iphonefor consistent experience on all browsers
  move away from setInterval entirely and towards webworker https://stackoverflow.com/questions/5927284/how-can-i-make-setinterval-also-work-when-a-tab-is-inactive-in-chrome
  robot voice or your own voice clips to say the messages
  choose how many pips (and set pips lower if people do super short exercises)

-->
<head>
  <style>
    div {
        font-size: 50px;
    }
    #message {
        color: blue;
    }
    #clock {
      font-size: 200px;
    }
    #startPause {
      font-size: 70px;
    }
    p {
      font-size: 15px;
    }
    h1 {
      font-size: 50px;
    }
    body {
      text-align: center;
    }

  </style>
</head>
<body>
  <h1>HIITMAN 2000:</h1>
  <h2>THE SINGLE MOST ADVANCED HIIT WEBSITE</h2>
  <button type="button" id="startPause">START</button>


  <div id=message>
    Welcome
  </div>
  <div id=clock>
  </div>
  <div id=percentageDone>
  </div>


  <p>example params: <a href="?e=squats,press-ups,sit-ups,skipping+rope&t=30&b=30&w=20">?e=squats,press-ups,sit-ups,skipping+rope&t=30&b=30&w=20</a></p>
  <p>e: a comma separated list of the names of the exercises you want to do, eg squats,press-ups,sit-ups,skipping rope</p>
  <p>t: in seconds, how long you want each bit of excercise to last, eg 30</p>
  <p>b: in seconds, how long you want each break between exercise to last, eg 30</p>
  <p>w: in minutes, how long you want the session to last, eg 20</p>

  <script type="text/javascript" src="https://tonejs.github.io/build/Tone.min.js"></script>


<script>
    var url = new URL(window.location.href);
    todayExercises = ["Mountain Climber","Squatty Floor Touch","Snakey Dog Pressups","Punchy Boys","High Knees!!"];
    breakLength = 30;
    exerciseLength = 30;
    workoutLength = 20*60;
    safariIndex = navigator.userAgent.indexOf("Safari");
    if(safariIndex === 125 || safariIndex === 131 || safariIndex === 102){
      console.log("i haven't worked out how to get url params for this browser");
    }
    else{
      url.searchParams.get("e") ? todayExercises = url.searchParams.get("e").split(",") : null;
      url.searchParams.get("b") ? breakLength = parseInt(url.searchParams.get("b")) : null;
      url.searchParams.get("t") ? exerciseLength = parseInt(url.searchParams.get("t")) : null;
      url.searchParams.get("w") ? workoutLength = parseInt(parseFloat(url.searchParams.get("w"))*60) : null;
    }
    segmentLength = breakLength + exerciseLength;
    initialCountDown = 5;
    absoluteLength = workoutLength + initialCountDown;
    secondsForAllocation = absoluteLength;
    exerciseIndex = 0;
    exerciseCounter = 0;

    events = {};
    setStart();
    setTheMeat();
    setEnd();
    console.log(events);

    function setTheMeat(){
      while (secondsForAllocation >= 0) {
        startAnExercise();
        startABreak();
        secondsForAllocation = secondsForAllocation - segmentLength;
        iterateExerciseIndex();
        exerciseCounter ++;
      }
    }

    function setStart(){
      events[0] = {
        "countDownValue": initialCountDown,
        "message":"Up first: " + todayExercises[0],
      };
    }

    function startAnExercise(){
      events[initialCountDown + (exerciseCounter * segmentLength)] = {
        "countDownValue": exerciseLength,
        "message": todayExercises[exerciseIndex],
        "type": "exercise",
        "sound":"beep"
      };
    }
    function startABreak(){
      events[initialCountDown + exerciseLength  + (exerciseCounter * segmentLength)] = {
        "countDownValue": breakLength,
        "message": "Break! up next: " + todayExercises[exerciseIndex + 1],
        "sound":"beep",
        "type":"break"
      };
    }

    function setEnd(){
      speculativeEnd = absoluteLength;
      endSet = false;
      while (endSet === false) {
        if (events[speculativeEnd] && events[speculativeEnd].type === "break"){
          events[speculativeEnd] = {
            "message": "Complete",
            "sound": "beep"
          };
          absoluteLength = speculativeEnd;
          endSet = true;
        }
        else if (events[speculativeEnd] && events[speculativeEnd].type === "exercise"){
          events[speculativeEnd + exerciseLength] = {
            "message": "Complete",
            "sound":"beep"
          };
          absoluteLength = speculativeEnd + exerciseLength;
          endSet = true;
        }
        else {
          speculativeEnd --;
        }
      }
    }

    function iterateExerciseIndex(){
      exerciseIndex = (exerciseIndex + 1) % todayExercises.length;
    }

    masterTime = 0;
    countDownTime = 0;
    message = "";
    workoutComplete = false;
    isPaused = false;

    scheduler = function(){
      if (isPaused === false){
        workoutComplete === false ? activeScheduler() : endScheduler();
      }
    }

    function activeScheduler(){
      if (events[masterTime])
      {
        events[masterTime].message ? message = events[masterTime].message : null;
        events[masterTime].message === "Complete" ? workoutComplete = true : null;
        events[masterTime].countDownValue ? countDownTime = events[masterTime].countDownValue : null;
        events[masterTime].sound === "beep" ? beep() : null;

      }
      masterTime === initialCountDown ? percentageDone() : null;
      countDownTime <= 5 ? pip() : null;

      document.getElementById("clock").innerHTML=countDownTime;
      document.getElementById("message").innerHTML=message;
      countDownTime --;
      masterTime ++;
    }

    function endScheduler(){
      document.getElementById("clock").innerHTML="";
      clearInterval(start);
    }

    document.getElementById("startPause").onclick = function(){startPauseButton()};
    function startPauseButton(){
      console.log("you pressed the button");
      if ( document.getElementById("startPause").innerHTML==="START"){
        setTimeout(scheduler,0);
        start = setInterval(scheduler, 1000);
        document.getElementById("startPause").innerHTML="PAUSE";
      }
      else if (isPaused === true) {
        isPaused = false;
        document.getElementById("startPause").innerHTML="PAUSE";
      }
      else {
        isPaused = true;
        document.getElementById("startPause").innerHTML="UNPAUSE";
      }
    }

    document.body.onkeyup = function(e){
      if(e.keyCode == 32){
        startPauseButton();
      }
    }

    var synth = new Tone.PolySynth().toMaster()

    function pip(){
      synth.triggerAttackRelease('E4', '64n');
      synth.triggerAttackRelease('E5', '64n');
    }
    function beep(){
      synth.triggerAttackRelease('C4', '4n');
      synth.triggerAttackRelease('C6', '4n');
    }
    percentage = 0;

    function percentageDone(){
      document.getElementById("percentageDone").innerHTML = percentage +"%";
      percentageInterval = setInterval(function(){
        if (isPaused === false) {
          percentage++;
          document.getElementById("percentageDone").innerHTML = percentage +"%";
          if (percentage == 100) {
            clearInterval(percentageInterval);
          }
        }
      },
      ( absoluteLength - initialCountDown ) * 10);
    }
  </script>
</body>
